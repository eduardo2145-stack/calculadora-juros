<script>
    function toggleMenu() {
        document.getElementById('mobileSidebar').classList.toggle('active');
        document.getElementById('menuOverlay').classList.toggle('active');
    }

    // --- MÁSCARAS DE DINHEIRO ---
    const moneyInputs = document.querySelectorAll('.money-input');
    moneyInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if(value === '') return;
            value = (parseInt(value) / 100).toFixed(2) + '';
            value = value.replace('.', ',');
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            e.target.value = 'R$ ' + value;
        });
    });
    
    function parseMoney(str) { 
        if(!str) return 0;
        let limpo = str.toString().replace(/[^\d,]/g, '');
        limpo = limpo.replace(',', '.');
        return parseFloat(limpo) || 0; 
    }

    // --- ABAS ---
    function openTab(tab) {
        document.getElementById('rendimento').style.display = tab === 'rendimento' ? 'block' : 'none';
        document.getElementById('meta').style.display = tab === 'meta' ? 'block' : 'none';
        
        let btnRend = document.getElementById('btn-rend');
        let btnMeta = document.getElementById('btn-meta');
        
        if(tab === 'rendimento') {
            btnRend.className = 'tab-btn active';
            btnMeta.className = 'tab-btn inactive';
        } else {
            btnRend.className = 'tab-btn inactive';
            btnMeta.className = 'tab-btn active';
        }
    }

    // --- CÁLCULOS (Juros e Meta) ---
    // (Mantive igual, pois já estava perfeito)
    let chartRend = null;
    let globalTableData = [];
    let pdfData = {};

    function calcularRendimento() {
        let P = parseMoney(document.getElementById('valorInicial').value);
        let M = parseMoney(document.getElementById('aporteMensal').value);
        let taxaAnual = parseFloat(document.getElementById('taxaJuros').value) || 0;
        let anos = parseFloat(document.getElementById('anos').value);
        let usarIR = document.getElementById('checkIR').checked;
        let usarInflacao = document.getElementById('checkInflacao').checked;
        
        if (!anos || anos <= 0) return alert("Preencha o tempo em anos.");

        let meses = anos * 12;
        let i = Math.pow(1 + (taxaAnual / 100), 1 / 12) - 1;
        let labels = [], dataBruto = [], dataInvestido = [];
        globalTableData = [];
        
        let totalInvestido = P;
        let saldoBruto = P;

        for(let m = 0; m <= meses; m++) {
            let jurosMes = 0;
            if (m > 0) {
                jurosMes = saldoBruto * i;
                saldoBruto += jurosMes + M;
                totalInvestido += M;
            }
            if (m % 6 === 0 || m === meses) {
                labels.push(m);
                dataInvestido.push(totalInvestido);
                dataBruto.push(saldoBruto);
            }
            if(m > 0 && (m % 1 === 0)) {
                globalTableData.push([
                    m, 
                    totalInvestido.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}),
                    jurosMes.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}),
                    saldoBruto.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})
                ]);
            }
        }

        const tbody = document.querySelector('#tabelaEvolucao tbody');
        tbody.innerHTML = '';
        let showData = globalTableData.length > 50 ? [...globalTableData.slice(0,12), ...globalTableData.slice(-12)] : globalTableData;
        showData.forEach(row => {
            tbody.innerHTML += `<tr><td>${row[0]}</td><td>${row[1]}</td><td style="color:green;">+${row[2]}</td><td><strong>${row[3]}</strong></td></tr>`;
        });

        let lucro = saldoBruto - totalInvestido;
        let valorIR = 0;
        let saldoLiquido = saldoBruto;
        
        if (usarIR) {
            let aliquota = 0.15; 
            if (meses < 6) aliquota = 0.225; else if (meses < 12) aliquota = 0.20; else if (meses < 24) aliquota = 0.175;
            valorIR = lucro * aliquota;
            saldoLiquido -= valorIR;
            document.getElementById('rowIR').style.display = 'flex';
            document.getElementById('resIR').innerText = '- ' + valorIR.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        } else { document.getElementById('rowIR').style.display = 'none'; }

        if(usarInflacao) {
            let inflacao = 4.5; 
            let deflator = Math.pow(1 + (inflacao/100), anos);
            let poderCompra = saldoLiquido / deflator;
            let perda = saldoLiquido - poderCompra;
            document.getElementById('rowInflacao').style.display = 'flex';
            document.getElementById('resInflacao').innerText = '- ' + perda.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        } else { document.getElementById('rowInflacao').style.display = 'none'; }

        document.getElementById('resTotalBruto').innerText = saldoLiquido.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('resInvestido').innerText = totalInvestido.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('resBrutoJuros').innerText = lucro.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('results-area').style.display = 'block';

        const ctx = document.getElementById('chartRendimento').getContext('2d');
        if (chartRend) chartRend.destroy();
        chartRend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Saldo Acumulado', data: dataBruto, borderColor: '#8B0000', backgroundColor: 'rgba(139,0,0,0.1)', fill: true },
                    { label: 'Investido', data: dataInvestido, borderColor: '#555', borderDash: [5,5], fill: false }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        pdfData = { total: document.getElementById('resTotalBruto').innerText, investido: document.getElementById('resInvestido').innerText };
    }

    function calcularMeta() {
        let obj = parseMoney(document.getElementById('metaValor').value);
        let ano = parseFloat(document.getElementById('metaAnos').value);
        let ini = parseMoney(document.getElementById('metaInicial').value);
        let tax = parseFloat(document.getElementById('metaTaxa').value);
        
        if(!obj || !ano) return alert("Preencha os campos.");
        
        let mes = ano * 12;
        let i = Math.pow(1 + (tax/100), 1/12) - 1;
        let pmt = (obj - ini * Math.pow(1+i, mes)) / ( (Math.pow(1+i, mes) - 1) / i );
        if(pmt < 0) pmt = 0;

        document.getElementById('resMetaMensal').innerText = pmt.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('meta-res').style.display = 'block';
    }

    async function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20); doc.setTextColor(139,0,0); doc.text("JurosWeb - Relatório", 20, 20);
        doc.setFontSize(12); doc.setTextColor(0,0,0);
        doc.text(`Total: ${pdfData.total}`, 20, 40); doc.text(`Investido: ${pdfData.investido}`, 20, 50);
        try {
            const canvas = document.getElementById('chartRendimento');
            doc.addImage(canvas.toDataURL('image/png'), 'PNG', 20, 70, 170, 90);
        } catch(e) {}
        doc.autoTable({ startY: 170, head: [['Mês', 'Investido', 'Juros', 'Total']], body: globalTableData.slice(0, 36) });
        doc.save('relatorio-jurosweb.pdf');
    }

    // --- LÓGICA DE NOTÍCIAS INTELIGENTE ---
    
    // 1. Banco de Dicas "Evergreen" (Nunca ficam velhas)
    const backupTips = [
        {title: "Entenda a Regra 50-30-20 para organizar seu orçamento mensal", link: "utilidades.html"},
        {title: "Reserva de Emergência: Onde investir para ter liquidez diária?", link: "index.html#simulador"},
        {title: "Como funciona a nova tabela progressiva do INSS 2026?", link: "salario.html"},
        {title: "Décimo Terceiro: Como calcular a primeira e segunda parcela?", link: "decimo.html"},
        {title: "Férias vencidas? Saiba como calcular o pagamento em dobro", link: "ferias.html"},
        {title: "Juros Compostos: A oitava maravilha do mundo nos seus investimentos", link: "index.html#simulador"},
        {title: "Diferença entre Taxa Selic e CDI: O guia completo", link: "utilidades.html"},
        {title: "Como declarar seus investimentos no Imposto de Renda", link: "salario.html"},
        {title: "Vale a pena antecipar o saque-aniversário do FGTS?", link: "regra3.html"},
        {title: "Tesouro Direto vs Poupança: Qual rende mais hoje?", link: "index.html#simulador"}
    ];

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    async function loadNews(termo = '', isSearch = false) {
        const query = termo || 'investimentos mercado financeiro brasil';
        const grid = document.getElementById('newsGrid');
        
        // Função de Renderização
        const renderNews = (items, isBackup = false) => {
            grid.innerHTML = '';
            
            // Se for backup, exibe um aviso discreto
            if(isBackup) {
                document.getElementById('lastUpdate').innerText = 'Dicas Financeiras (Modo Offline)';
            }

            // Lógica do Hero (Destaque)
            if (!isSearch && items.length > 0) {
                const hero = items[0];
                document.getElementById('heroTitle').innerText = hero.title;
                document.getElementById('heroLink').href = hero.link;
                let heroImg = hero.enclosure ? hero.enclosure.link : 'IMG/news1.jpg';
                document.getElementById('heroImg').src = heroImg;
                document.getElementById('heroImg').onerror = function() { this.src = 'IMG/news1.jpg'; };
            }

            // Lógica da Grade
            // Se for busca ou backup, mostra tudo. Se for home live, pula o primeiro.
            let list = (isSearch || isBackup) ? items : items.slice(1);
            list = list.slice(0, 6); // Limita a 6

            list.forEach((item, idx) => {
                // Rodízio de imagens locais (1 a 6) para backups ou falhas
                let fallbackImg = `IMG/news${(idx % 6) + 1}.jpg`;
                let imgUrl = item.enclosure ? item.enclosure.link : fallbackImg;
                
                grid.innerHTML += `
                <a href="${item.link}" target="_blank" class="news-card">
                    <div class="news-img-box">
                        <img src="${imgUrl}" onerror="this.src='${fallbackImg}'" class="news-img" loading="lazy">
                    </div>
                    <div class="news-body">
                        <div class="news-tag">${isBackup ? 'Dica' : 'Mercado'}</div>
                        <div class="news-title">${item.title}</div>
                        <div class="news-meta">Ler mais →</div>
                    </div>
                </a>`;
            });
        };

        // Cache Management
        const CACHE_KEY = 'jurosweb_news_cache';
        const CACHE_TIME = 1000 * 60 * 60; // 1 Hora de validade

        // Se for busca, ignora cache e vai direto pra API
        if (isSearch) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); // 3s timeout
            try {
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://news.google.com/rss/search?q='+query+'&hl=pt-BR&gl=BR&ceid=BR:pt-419')}`, { signal: controller.signal });
                clearTimeout(timeoutId);
                const data = await res.json();
                if(data.status === 'ok' && data.items.length > 0) {
                    renderNews(data.items);
                    document.getElementById('lastUpdate').innerText = 'Resultado da busca';
                } else { throw new Error("Busca vazia"); }
            } catch(e) {
                alert("Não foi possível buscar agora. Mostrando dicas financeiras.");
                renderNews(shuffleArray([...backupTips]).slice(0,6), true);
            }
            return;
        }

        // Se for Home, tenta: API -> Cache -> Backup Aleatório
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 2000);

        try {
            const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://news.google.com/rss/search?q='+query+'&hl=pt-BR&gl=BR&ceid=BR:pt-419')}`, { signal: controller.signal });
            clearTimeout(timeoutId);
            const data = await res.json();
            
            if(data.status === 'ok' && data.items.length > 0) {
                // Sucesso! Salva no cache e renderiza
                localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), items: data.items }));
                renderNews(data.items);
                document.getElementById('lastUpdate').innerText = 'Atualizado agora';
            } else { throw new Error("API Error"); }

        } catch(e) {
            // Falha na API. Tenta o Cache.
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const cData = JSON.parse(cached);
                // Se cache tem menos de 2 horas, usa ele
                if (Date.now() - cData.timestamp < (CACHE_TIME * 2)) {
                    renderNews(cData.items);
                    document.getElementById('lastUpdate').innerText = 'Versão salva anteriormente';
                    return;
                }
            }
            
            // Se não tem cache ou é muito velho: Usa Dicas Aleatórias
            // Embaralha o array de dicas para sempre mostrar algo diferente
            const randomTips = shuffleArray([...backupTips]).slice(0, 7); 
            renderNews(randomTips, true);
        }
    }

    function realizarBusca() {
        let val = document.getElementById('campoBusca').value;
        if(val) {
            loadNews(val, true);
            document.getElementById('noticias').scrollIntoView({behavior:'smooth'});
        }
    }

    window.onload = function() {
        loadNews(); // Carrega Home
        document.getElementById('campoBusca').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') realizarBusca();
        });
    };
</script>
